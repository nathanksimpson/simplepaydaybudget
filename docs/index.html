<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Payday Calculator</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7f9;
        --card: #ffffff;
        --text: #1f2328;
        --muted: #5b6673;
        --accent: #2563eb;
        --border: #e3e6ea;
        --danger: #b91c1c;
        --warning: #d97706;
        --success: #15803d;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.5;
      }

      .page {
        max-width: 1120px;
        margin: 0 auto;
        padding: 24px;
      }

      h1 {
        margin: 0 0 8px;
        font-size: 26px;
      }

      h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      p {
        margin: 8px 0;
      }

      .app-header {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 20px;
      }

      .app-subtitle {
        max-width: 640px;
      }

      .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .layout {
        display: grid;
        gap: 16px;
      }

      .column {
        min-width: 0;
      }

      .stack {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }

      label {
        display: block;
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      input,
      select,
      textarea,
      button {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        font-size: 14px;
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
      }

      .inline {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      button {
        background: var(--accent);
        color: #fff;
        border: none;
        cursor: pointer;
      }

      .header-actions button,
      .buttons button,
      .section-toolbar button {
        width: auto;
      }

      button.secondary {
        background: #4b5563;
      }

      button.ghost {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
      }

      .icon-danger {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        background: #fee2e2;
        color: var(--danger);
        border: 1px solid #fecaca;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .warning {
        color: var(--warning);
        font-weight: 600;
      }

      .danger {
        color: var(--danger);
        font-weight: 700;
      }

      .success {
        color: var(--success);
        font-weight: 600;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th,
      .table td {
        padding: 8px 6px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        font-size: 14px;
      }

      .table th:nth-child(3),
      .table td:nth-child(3) {
        width: 120px;
      }

      .table td:nth-child(3) input {
        font-size: 12px;
        padding: 6px 8px;
      }

      .table td label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .bills-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
      }

      .bill-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
        display: grid;
        gap: 10px;
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      }

      .bill-card .bill-header {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .bill-card .bill-header input {
        flex: 1;
      }

      .bill-card .bill-fields {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      .bill-card .bill-fields .full {
        grid-column: 1 / -1;
      }

      @media (max-width: 720px) {
        .bills-grid {
          grid-template-columns: 1fr;
        }
      }

      .table th {
        color: var(--muted);
        font-weight: 600;
      }

      .chip {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: #eef2ff;
        color: #4338ca;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }

      .results-bar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--card);
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
      }

      .results-bar > summary {
        list-style: none;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px;
        cursor: pointer;
        font-weight: 600;
      }

      .results-bar > summary::-webkit-details-marker {
        display: none;
      }

      .results-bar > summary::after {
        content: "+";
        color: var(--muted);
        font-weight: 700;
      }

      .results-bar[open] > summary::after {
        content: "-";
      }

      .results-compact {
        display: flex;
        flex-direction: column;
        gap: 2px;
        text-align: right;
        border: 1px solid #d9dde3;
        border-radius: 10px;
        padding: 8px 12px;
        background: #f4f6f9;
        box-shadow: inset 0 2px 6px rgba(15, 23, 42, 0.12);
      }

      .results-compact-label {
        font-size: 13px;
        color: var(--muted);
      }

      .results-compact-value {
        font-size: 26px;
        font-weight: 700;
      }

      .budget-good {
        color: var(--success);
      }

      .budget-bad {
        color: var(--warning);
      }

      .results-body {
        padding: 0 16px 16px;
      }

      .result-box {
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fafafa;
      }

      .result-box.recessed {
        background: #f4f6f9;
        border-color: #d9dde3;
        box-shadow: inset 0 2px 6px rgba(15, 23, 42, 0.12);
      }

      .result-value {
        font-size: 20px;
        font-weight: 700;
      }

      .tooltip {
        text-decoration: underline dotted;
        cursor: help;
      }

      .section {
        padding: 0;
      }

      .section > summary {
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
      }

      .section > summary::-webkit-details-marker {
        display: none;
      }

      .section > summary::after {
        content: "+";
        color: var(--muted);
        font-weight: 700;
      }

      .section[open] > summary {
        border-bottom: 1px solid var(--border);
      }

      .section[open] > summary::after {
        content: "-";
      }

      .section-body {
        padding: 16px;
      }

      .section-toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 8px;
      }

      @media (min-width: 900px) {
        h1 {
          font-size: 30px;
        }

        .layout {
          grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
          align-items: start;
        }

        .results-bar {
          top: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="app-header">
        <div>
          <h1>Payday Calculator</h1>
          <p class="muted app-subtitle">
            Figure out how much you can spend each day until payday. Fill in your
            balance, bills, and schedule, and the results update automatically.
          </p>
        </div>
        <div class="header-actions">
          <button id="saveState" type="button">Save</button>
          <button id="loadState" class="secondary" type="button">Load</button>
          <button id="exportState" class="ghost" type="button">Export</button>
        </div>
      </header>

      <details class="results-bar card" id="resultsBar">
        <summary>
          <span>Results</span>
          <span class="results-compact">
            <span id="resultsCompactLabel" class="results-compact-label">Daily budget</span>
            <span id="resultsCompactValue" class="results-compact-value">--</span>
          </span>
        </summary>
        <div class="results-body">
          <div class="results-grid">
            <div class="result-box">
              <div class="muted">Days remaining</div>
              <div id="daysRemaining" class="result-value">--</div>
              <div class="muted">
                <span class="tooltip" title="We count full days between today and payday. Today is not counted as a spendable day.">
                  Exclusive day logic
                </span>
              </div>
            </div>
            <div class="result-box">
              <div class="muted">Next payday</div>
              <div id="paydayLabel" class="result-value">--</div>
              <div id="paydayIn" class="muted"></div>
            </div>
            <div class="result-box">
              <div class="muted">Remaining balance</div>
              <div id="remainingBalance" class="result-value">--</div>
            </div>
            <div class="result-box">
              <div class="muted">Daily allowance</div>
              <div id="dailyAllowance" class="result-value">--</div>
            </div>
            <div class="result-box">
              <div class="muted">Weekly Budget (Sun-Sat)</div>
              <div id="weeklyAllowance" class="result-value">--</div>
            </div>
            <div class="result-box">
              <div class="muted">Savings per day</div>
              <div id="savingsPerDay" class="result-value">--</div>
            </div>
            <div class="result-box">
              <div class="muted">Allowance after savings</div>
              <div id="afterSavings" class="result-value">--</div>
            </div>
          </div>
          <div id="warnings" style="margin-top: 10px"></div>
        </div>
      </details>

      <div class="layout">
        <div class="column stack">
          <details class="section card" data-section>
            <summary>Balance and Goals</summary>
            <div class="section-body">
              <div class="grid">
                <div>
                  <label for="balance">Current balance</label>
                  <input id="balance" type="number" min="0" step="0.01" />
                </div>
                <div class="inline" style="align-items: flex-end">
                  <label>
                    <input id="dailyTargetEnabled" type="checkbox" />
                    Use a spending target
                  </label>
                </div>
                <div>
                  <label for="dailyTarget">Spending target amount</label>
                  <input id="dailyTarget" type="number" min="0" step="0.01" />
                </div>
                <div>
                  <label for="targetPeriod">Target period</label>
                  <select id="targetPeriod">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly (Sun-Sat)</option>
                  </select>
                  <div class="muted">Weekly compares against the remaining days this week.</div>
                </div>
                <div class="inline" style="align-items: flex-end">
                  <label>
                    <input id="savingsGoalEnabled" type="checkbox" />
                    Use a savings goal by payday
                  </label>
                </div>
                <div>
                  <label for="savingsGoal">Savings goal amount</label>
                  <input id="savingsGoal" type="number" min="0" step="0.01" />
                </div>
              </div>
            </div>
          </details>

          <details class="section card" data-section>
            <summary>Payday Schedule</summary>
            <div class="section-body">
              <div class="grid">
                <div>
                  <label for="scheduleMode">Schedule type</label>
                  <select id="scheduleMode">
                    <option value="manual">Manual date</option>
                    <option value="recurring">Recurring</option>
                  </select>
                </div>
                <div>
                  <label for="manualDate">Next payday (manual)</label>
                  <input id="manualDate" type="date" />
                </div>
              </div>
              <div class="grid" style="margin-top: 12px">
                <div>
                  <label for="recurrenceType">Recurring type</label>
                  <select id="recurrenceType">
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Biweekly</option>
                    <option value="monthly">Monthly</option>
                  </select>
                </div>
                <div>
                  <label for="anchorDate">Anchor date</label>
                  <input id="anchorDate" type="date" />
                </div>
                <div>
                  <label for="interval">Interval</label>
                  <input id="interval" type="number" min="1" step="1" />
                  <div class="muted">
                    Weekly/biweekly use weeks. Monthly uses months.
                  </div>
                </div>
              </div>
            </div>
          </details>

          <details class="section card" data-section>
            <summary>Bills</summary>
            <div class="section-body">
              <div class="section-toolbar">
                <div class="muted">Only bills that occur before the next payday are subtracted.</div>
                <button id="addBill" class="ghost" type="button">Add bill</button>
              </div>
              <div id="billsBody" class="bills-grid" style="margin-top: 8px"></div>
            </div>
          </details>

          <details class="section card" data-section>
            <summary>Import / Export</summary>
            <div class="section-body">
              <div class="grid">
                <div>
                  <label for="importFile">Import from file</label>
                  <input id="importFile" type="file" accept="application/json" />
                </div>
                <div>
                  <label for="importText">Paste JSON</label>
                  <textarea id="importText" placeholder="Paste exported JSON here..."></textarea>
                </div>
              </div>
              <div class="buttons" style="margin-top: 8px">
                <button id="previewImport" class="secondary" type="button">
                  Preview import
                </button>
                <button id="applyImport" type="button" disabled>
                  Confirm overwrite
                </button>
              </div>
              <div id="importPreview" class="muted" style="margin-top: 10px"></div>
            </div>
          </details>

          <details class="section card" data-section>
            <summary>Session</summary>
            <div class="section-body">
              <div class="buttons">
                <button id="resetState" class="ghost" type="button">Reset</button>
              </div>
              <div class="muted">Resets the form and clears saved browser data.</div>
            </div>
          </details>
        </div>

        <div class="column stack">
          <div class="card">
            <h2>Help</h2>
            <p><span class="chip">How it works</span> We find your next payday, count how many days remain, subtract bills that happen before payday, and divide the remaining balance by the days left.</p>
            <p><span class="chip">Assumptions</span> Dates use your local time. Bills are simple fixed amounts and do not account for tax or fees. Savings goals are assumed due by payday.</p>
            <p><span class="chip">Limitations</span> This is a simple calculator and does not replace a full budget planner.</p>
            <p><span class="chip">Future ideas</span> Multiple incomes, savings goals, calendar view, CSV export, currency selection, and an emergency buffer.</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const State = (() => {
        const defaultState = () => ({
          balance: 0,
          scheduleMode: "manual",
          manualDate: "",
          recurrence: {
            type: "weekly",
            anchorDate: "",
            interval: 1,
          },
          dailyTargetEnabled: false,
          dailyTarget: 0,
          targetPeriod: "daily",
          savingsGoalEnabled: false,
          savingsGoal: 0,
          bills: [],
        });

        let state = defaultState();

        const get = () => state;
        const set = (nextState) => {
          state = nextState;
        };
        const reset = () => {
          state = defaultState();
        };

        return { get, set, reset, defaultState };
      })();

      const Calculator = (() => {
        const toLocalMidnight = (date) => {
          const local = new Date(date);
          local.setHours(0, 0, 0, 0);
          return local;
        };

        const parseYMD = (value) => {
          if (!value) return null;
          const parsed = new Date(`${value}T00:00:00`);
          if (Number.isNaN(parsed.getTime())) return null;
          return toLocalMidnight(parsed);
        };

        const formatYMD = (date) => {
          if (!date) return "";
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        };

        const daysBetween = (start, end) => {
          const ms = end.getTime() - start.getTime();
          return Math.floor(ms / 86400000);
        };

        const clampDay = (year, monthIndex, day) => {
          const lastDay = new Date(year, monthIndex + 1, 0).getDate();
          return Math.min(day, lastDay);
        };

        const addMonthsClamped = (date, months) => {
          const year = date.getFullYear();
          const monthIndex = date.getMonth() + months;
          const day = date.getDate();
          const target = new Date(year, monthIndex, 1);
          const clampedDay = clampDay(target.getFullYear(), target.getMonth(), day);
          return new Date(target.getFullYear(), target.getMonth(), clampedDay);
        };

        const resolveRecurringDate = (anchorDate, type, interval, afterDate) => {
          if (!anchorDate) return null;
          const anchor = parseYMD(anchorDate);
          if (!anchor) return null;
          const baseInterval = Math.max(1, Number(interval) || 1);
          let current = anchor;
          let guard = 0;
          const maxSteps = 1000;

          while (current <= afterDate && guard < maxSteps) {
            if (type === "monthly") {
              current = addMonthsClamped(current, baseInterval);
            } else {
              const weeks = type === "biweekly" ? baseInterval * 2 : baseInterval;
              current = new Date(current.getTime() + weeks * 7 * 86400000);
            }
            guard += 1;
          }

          return guard >= maxSteps ? null : current;
        };

        const getNextPayday = (state) => {
          const today = toLocalMidnight(new Date());
          if (state.scheduleMode === "manual") {
            const manual = parseYMD(state.manualDate);
            if (!manual) return null;
            return manual > today ? manual : null;
          }

          const { type, anchorDate, interval } = state.recurrence;
          return resolveRecurringDate(anchorDate, type, interval, today);
        };

        const getBillOccurrences = (bill, rangeStart, rangeEnd) => {
          const occurrences = [];
          const due = parseYMD(bill.dueDate);
          if (!due) return occurrences;

          if (bill.recurring === "none") {
            if (due >= rangeStart && due < rangeEnd) {
              occurrences.push(due);
            }
            return occurrences;
          }

          const baseInterval = 1;
          let current = due;
          let guard = 0;
          const maxSteps = 1000;

          while (current < rangeEnd && guard < maxSteps) {
            if (current >= rangeStart && current < rangeEnd) {
              occurrences.push(current);
            }

            if (bill.recurring === "monthly") {
              current = addMonthsClamped(current, baseInterval);
            } else {
              const weeks = bill.recurring === "biweekly" ? baseInterval * 2 : baseInterval;
              current = new Date(current.getTime() + weeks * 7 * 86400000);
            }
            guard += 1;
          }

          return occurrences;
        };

        const sumBills = (bills, rangeStart, rangeEnd) => {
          let total = 0;
          const usedBills = [];

          bills.forEach((bill) => {
            const amount = Number(bill.amount) || 0;
            if (amount < 0) return;

            const occurrences = getBillOccurrences(bill, rangeStart, rangeEnd);
            occurrences.forEach((date) => {
              total += amount;
              usedBills.push({ ...bill, occurrence: formatYMD(date) });
            });
          });

          return { total, usedBills };
        };

        const calculate = (state) => {
          const today = toLocalMidnight(new Date());
          const payday = getNextPayday(state);
          const errors = [];

          if (Number(state.balance) < 0) {
            errors.push("Balance must be 0 or more.");
          }

          if (Number(state.savingsGoal) < 0) {
            errors.push("Savings goal must be 0 or more.");
          }

          state.bills.forEach((bill) => {
            if (Number(bill.amount) < 0) {
              errors.push(`Bill "${bill.name || "Unnamed"}" must be 0 or more.`);
            }
          });

          if (!payday) {
            errors.push("Payday must be in the future.");
          }

          const daysRemaining = payday ? daysBetween(today, payday) : 0;
          if (payday && daysRemaining <= 0) {
            errors.push("Days until payday must be more than 0.");
          }

          const { total: billsTotal } = payday
            ? sumBills(state.bills, today, payday)
            : { total: 0 };

          const remaining = Number(state.balance) - billsTotal;
          const safeDays = Math.max(daysRemaining, 1);
          const daily = remaining / safeDays;
          const goalAmount = state.savingsGoalEnabled ? Number(state.savingsGoal) || 0 : 0;
          const savingsPerDay = goalAmount / safeDays;
          const afterSavings = (remaining - goalAmount) / safeDays;

          return {
            payday,
            daysRemaining,
            billsTotal,
            remaining,
            daily,
            savingsPerDay,
            afterSavings,
            goalAmount,
            errors,
          };
        };

        return {
          calculate,
          parseYMD,
          formatYMD,
          getNextPayday,
          toLocalMidnight,
        };
      })();

      const Storage = (() => {
        const KEY = "paydayCalc_v1";

        const save = (data) => {
          localStorage.setItem(KEY, JSON.stringify({ version: 1, data }));
        };

        const load = () => {
          const raw = localStorage.getItem(KEY);
          if (!raw) return null;
          try {
            return JSON.parse(raw);
          } catch (error) {
            return null;
          }
        };

        const clear = () => {
          localStorage.removeItem(KEY);
        };

        return { save, load, clear, KEY };
      })();

      const ImportExport = (() => {
        const looksLikeState = (maybeState) => {
          if (!maybeState || typeof maybeState !== "object") return false;
          return (
            "balance" in maybeState ||
            "scheduleMode" in maybeState ||
            "bills" in maybeState ||
            "recurrence" in maybeState
          );
        };

        const applyDefaults = (partial) => {
          const base = State.defaultState();
          const safeBills = Array.isArray(partial.bills) ? partial.bills : base.bills;
          const safeRecurrence = {
            ...base.recurrence,
            ...(partial.recurrence || {}),
          };
          return {
            ...base,
            ...partial,
            recurrence: safeRecurrence,
            bills: safeBills,
          };
        };

        const migrateLegacyState = (legacy) => {
          const base = State.defaultState();
          const legacyTarget = Number(legacy.target) || 0;
          const schedule = legacy.schedule || {};
          const bills = Array.isArray(legacy.bills)
            ? legacy.bills.map((bill) => ({
                ...bill,
                recurring: bill.recurring || "none",
              }))
            : [];
          return applyDefaults({
            balance: Number(legacy.balance) || 0,
            dailyTarget: legacyTarget,
            dailyTargetEnabled: legacyTarget > 0,
            targetPeriod: "daily",
            scheduleMode: schedule.type ? "recurring" : base.scheduleMode,
            recurrence: {
              type: schedule.type || base.recurrence.type,
              anchorDate: schedule.anchorDate || base.recurrence.anchorDate,
              interval: Number(schedule.interval) || base.recurrence.interval,
            },
            bills,
          });
        };

        const normalize = (payload) => {
          if (!payload || typeof payload !== "object") return null;
          if (payload.version === 1 && payload.data) return payload;
          if (payload.version === 1 && !payload.data) {
            return { version: 1, data: migrateLegacyState(payload) };
          }
          if (looksLikeState(payload)) {
            return { version: 1, data: applyDefaults(payload) };
          }
          return null;
        };

        const validate = (payload) => {
          const errors = [];
          const normalized = normalize(payload);
          if (!normalized) {
            errors.push("Missing data object.");
            return { ok: false, errors, normalized: null };
          }
          if (normalized.version !== 1) {
            errors.push("Unsupported or missing version.");
          }
          if (typeof normalized.data !== "object") {
            errors.push("Missing data object.");
          }
          return { ok: errors.length === 0, errors, normalized };
        };

        const exportData = (state) => {
          const blob = new Blob([JSON.stringify({ version: 1, data: state }, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "payday-session.json";
          link.click();
          URL.revokeObjectURL(url);
        };

        return { validate, exportData };
      })();

      const UI = (() => {
        const elements = {
          balance: document.getElementById("balance"),
          dailyTargetEnabled: document.getElementById("dailyTargetEnabled"),
          dailyTarget: document.getElementById("dailyTarget"),
          targetPeriod: document.getElementById("targetPeriod"),
          savingsGoalEnabled: document.getElementById("savingsGoalEnabled"),
          savingsGoal: document.getElementById("savingsGoal"),
          scheduleMode: document.getElementById("scheduleMode"),
          manualDate: document.getElementById("manualDate"),
          recurrenceType: document.getElementById("recurrenceType"),
          anchorDate: document.getElementById("anchorDate"),
          interval: document.getElementById("interval"),
          billsBody: document.getElementById("billsBody"),
          addBill: document.getElementById("addBill"),
          daysRemaining: document.getElementById("daysRemaining"),
          paydayLabel: document.getElementById("paydayLabel"),
          paydayIn: document.getElementById("paydayIn"),
          remainingBalance: document.getElementById("remainingBalance"),
          dailyAllowance: document.getElementById("dailyAllowance"),
          weeklyAllowance: document.getElementById("weeklyAllowance"),
          savingsPerDay: document.getElementById("savingsPerDay"),
          afterSavings: document.getElementById("afterSavings"),
          warnings: document.getElementById("warnings"),
          saveState: document.getElementById("saveState"),
          loadState: document.getElementById("loadState"),
          resetState: document.getElementById("resetState"),
          exportState: document.getElementById("exportState"),
          importFile: document.getElementById("importFile"),
          importText: document.getElementById("importText"),
          previewImport: document.getElementById("previewImport"),
          applyImport: document.getElementById("applyImport"),
          importPreview: document.getElementById("importPreview"),
          resultsBar: document.getElementById("resultsBar"),
          resultsCompactLabel: document.getElementById("resultsCompactLabel"),
          resultsCompactValue: document.getElementById("resultsCompactValue"),
        };

        let pendingImport = null;

        const formatMoney = (value) =>
          Number.isFinite(value)
            ? value.toLocaleString(undefined, { style: "currency", currency: "USD" })
            : "--";

        const renderBills = () => {
          elements.billsBody.innerHTML = "";
          const { bills } = State.get();

          bills.forEach((bill, index) => {
            const card = document.createElement("div");
            card.className = "bill-card";
            card.innerHTML = `
              <div class="bill-header">
                <input id="bill-name-${index}" data-field="name" data-index="${index}" value="${bill.name || ""}" placeholder="Bill name" />
                <button class="icon-danger" data-action="remove" data-index="${index}" type="button" aria-label="Remove bill">
                  Ã—
                </button>
              </div>
              <div class="bill-fields">
                <div>
                  <label for="bill-amount-${index}">Amount</label>
                  <input id="bill-amount-${index}" data-field="amount" data-index="${index}" type="number" min="0" step="0.01" value="${bill.amount ?? ""}" />
                </div>
                <div>
                  <label for="bill-due-${index}">Due date</label>
                  <input id="bill-due-${index}" data-field="dueDate" data-index="${index}" type="date" value="${bill.dueDate || ""}" />
                </div>
                <div class="full">
                  <label for="bill-recurring-${index}">Recurring</label>
                  <select id="bill-recurring-${index}" data-field="recurring" data-index="${index}">
                    <option value="none" ${bill.recurring === "none" ? "selected" : ""}>None</option>
                    <option value="weekly" ${bill.recurring === "weekly" ? "selected" : ""}>Weekly</option>
                    <option value="biweekly" ${bill.recurring === "biweekly" ? "selected" : ""}>Biweekly</option>
                    <option value="monthly" ${bill.recurring === "monthly" ? "selected" : ""}>Monthly</option>
                  </select>
                </div>
              </div>
            `;

            elements.billsBody.appendChild(card);
          });
        };

        const updateStateFromInputs = () => {
          const state = State.get();
          const nextState = {
            ...state,
            balance: Number(elements.balance.value) || 0,
            scheduleMode: elements.scheduleMode.value,
            manualDate: elements.manualDate.value,
            recurrence: {
              type: elements.recurrenceType.value,
              anchorDate: elements.anchorDate.value,
              interval: Number(elements.interval.value) || 1,
            },
            dailyTargetEnabled: elements.dailyTargetEnabled.checked,
            dailyTarget: Number(elements.dailyTarget.value) || 0,
            targetPeriod: elements.targetPeriod.value,
            savingsGoalEnabled: elements.savingsGoalEnabled.checked,
            savingsGoal: Number(elements.savingsGoal.value) || 0,
          };
          State.set(nextState);
        };

        const renderResults = () => {
          const state = State.get();
          const result = Calculator.calculate(state);

          elements.daysRemaining.textContent = result.payday
            ? result.daysRemaining
            : "--";

          elements.paydayLabel.textContent = result.payday
            ? Calculator.formatYMD(result.payday)
            : "--";

          elements.paydayIn.textContent = result.payday
            ? `Payday in ${result.daysRemaining} days`
            : "";

          elements.remainingBalance.textContent = formatMoney(result.remaining);
          elements.dailyAllowance.textContent = formatMoney(result.daily);
          elements.savingsPerDay.textContent = formatMoney(result.savingsPerDay);
          elements.afterSavings.textContent = formatMoney(result.afterSavings);
          const compareDaily = state.savingsGoalEnabled ? result.afterSavings : result.daily;
          const today = Calculator.toLocalMidnight(new Date());
          const daysLeftInWeek = Math.max(0, 6 - today.getDay());
          const weeklyAllowance = compareDaily * daysLeftInWeek;
          elements.weeklyAllowance.textContent = formatMoney(weeklyAllowance);
          const compactIsWeekly = state.targetPeriod === "weekly";
          elements.resultsCompactLabel.textContent = compactIsWeekly
            ? "Weekly Budget"
            : "Daily budget";
          elements.resultsCompactValue.textContent = formatMoney(
            compactIsWeekly ? weeklyAllowance : compareDaily
          );
          elements.resultsCompactValue.classList.remove("budget-good", "budget-bad");
          if (state.dailyTargetEnabled && Number(state.dailyTarget) > 0) {
            const targetValue = Number(state.dailyTarget);
            const compactValue = compactIsWeekly ? weeklyAllowance : compareDaily;
            elements.resultsCompactValue.classList.add(
              compactValue >= targetValue ? "budget-good" : "budget-bad"
            );
          }

          let warningsHtml = "";
          result.errors.forEach((error) => {
            warningsHtml += `<div class="danger">${error}</div>`;
          });

          if (result.remaining < 0) {
            warningsHtml += `<div class="danger">Remaining balance is negative.</div>`;
          }

          if (state.savingsGoalEnabled && result.goalAmount > result.remaining) {
            warningsHtml += `<div class="warning">Savings goal is larger than your remaining balance.</div>`;
          }

          let compareTarget = compareDaily;
          let targetWarning = "Allowance is below your target.";
          if (state.targetPeriod === "weekly") {
            const today = Calculator.toLocalMidnight(new Date());
            const daysLeftInWeek = Math.max(0, 6 - today.getDay());
            compareTarget = compareDaily * daysLeftInWeek;
            targetWarning = "Weekly allowance is below your target.";
          }
          if (
            state.dailyTargetEnabled &&
            Number(state.dailyTarget) > 0 &&
            compareTarget < Number(state.dailyTarget)
          ) {
            warningsHtml += `<div class="warning">${targetWarning}</div>`;
          } else if (state.dailyTargetEnabled && Number(state.dailyTarget) > 0) {
            const targetLabel = state.targetPeriod === "weekly" ? "Weekly" : "Daily";
            warningsHtml += `<div class="success">${targetLabel} budget meets or exceeds your target.</div>`;
          }

          elements.warnings.innerHTML = warningsHtml;
        };

        const syncInputsFromState = () => {
          const state = State.get();
          elements.balance.value = state.balance;
          elements.scheduleMode.value = state.scheduleMode;
          elements.manualDate.value = state.manualDate;
          elements.recurrenceType.value = state.recurrence.type;
          elements.anchorDate.value = state.recurrence.anchorDate;
          elements.interval.value = state.recurrence.interval;
          elements.dailyTargetEnabled.checked = state.dailyTargetEnabled;
          elements.dailyTarget.value = state.dailyTarget;
          elements.targetPeriod.value = state.targetPeriod || "daily";
          elements.savingsGoalEnabled.checked = state.savingsGoalEnabled;
          elements.savingsGoal.value = state.savingsGoal;
          renderBills();
        };

        const refresh = () => {
          updateStateFromInputs();
          renderResults();
        };

        const handleBillInput = (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const field = target.dataset.field;
          const index = Number(target.dataset.index);
          if (Number.isNaN(index) || !field) return;

          const state = State.get();
          const bills = [...state.bills];
          const bill = { ...bills[index] };
          bill[field] = target.value;
          if (field === "amount") {
            bill.amount = Number(target.value) || 0;
          }
          bills[index] = bill;
          State.set({ ...state, bills });
          renderResults();
        };

        const handleBillRemove = (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          if (target.dataset.action !== "remove") return;
          const index = Number(target.dataset.index);
          const state = State.get();
          const bills = state.bills.filter((_, i) => i !== index);
          State.set({ ...state, bills });
          renderBills();
          renderResults();
        };

        const handlePreviewImport = (data) => {
          const validation = ImportExport.validate(data);
          if (!validation.ok) {
            elements.importPreview.innerHTML = validation.errors
              .map((error) => `<div class="danger">${error}</div>`)
              .join("");
            elements.applyImport.disabled = true;
            pendingImport = null;
            return;
          }

          pendingImport = validation.normalized.data;
          elements.importPreview.innerHTML = `
            <div class="success">Import looks valid. Review below:</div>
            <pre>${JSON.stringify(validation.normalized.data, null, 2)}</pre>
          `;
          elements.applyImport.disabled = false;
        };

        const bindEvents = () => {
          [
            elements.balance,
            elements.dailyTargetEnabled,
            elements.dailyTarget,
            elements.targetPeriod,
            elements.savingsGoalEnabled,
            elements.savingsGoal,
            elements.scheduleMode,
            elements.manualDate,
            elements.recurrenceType,
            elements.anchorDate,
            elements.interval,
          ].forEach((input) => {
            input.addEventListener("input", refresh);
            input.addEventListener("change", refresh);
          });

          elements.addBill.addEventListener("click", () => {
            const state = State.get();
            const bills = [
              ...state.bills,
              {
                name: "",
                amount: 0,
                dueDate: "",
                recurring: "none",
              },
            ];
            State.set({ ...state, bills });
            renderBills();
            renderResults();
          });

          elements.billsBody.addEventListener("input", handleBillInput);
          elements.billsBody.addEventListener("change", handleBillInput);
          elements.billsBody.addEventListener("click", handleBillRemove);

          elements.saveState.addEventListener("click", () => {
            Storage.save(State.get());
          });

          elements.loadState.addEventListener("click", () => {
            const payload = Storage.load();
            if (payload && payload.data) {
              State.set(payload.data);
              syncInputsFromState();
              renderResults();
            }
          });

          elements.resetState.addEventListener("click", () => {
            State.reset();
            Storage.clear();
            syncInputsFromState();
            renderResults();
          });

          elements.exportState.addEventListener("click", () => {
            ImportExport.exportData(State.get());
          });

          elements.importFile.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              try {
                const parsed = JSON.parse(reader.result);
                handlePreviewImport(parsed);
              } catch (error) {
                elements.importPreview.innerHTML = `<div class="danger">Invalid JSON file.</div>`;
              }
            };
            reader.readAsText(file);
          });

          elements.previewImport.addEventListener("click", () => {
            if (!elements.importText.value.trim()) {
              elements.importPreview.innerHTML = `<div class="danger">Paste JSON or choose a file first.</div>`;
              return;
            }
            try {
              const parsed = JSON.parse(elements.importText.value);
              handlePreviewImport(parsed);
            } catch (error) {
              elements.importPreview.innerHTML = `<div class="danger">Invalid JSON.</div>`;
            }
          });

          elements.applyImport.addEventListener("click", () => {
            if (!pendingImport) return;
            State.set(pendingImport);
            syncInputsFromState();
            renderResults();
            elements.importPreview.innerHTML = `<div class="success">Import applied.</div>`;
            elements.applyImport.disabled = true;
            pendingImport = null;
          });
        };

        const setupSections = () => {
          const media = window.matchMedia("(min-width: 900px)");
          const applyState = () => {
            document.querySelectorAll("details[data-section]").forEach((detail) => {
              detail.open = media.matches;
            });
          };
          applyState();
          if (typeof media.addEventListener === "function") {
            media.addEventListener("change", applyState);
          } else if (typeof media.addListener === "function") {
            media.addListener(applyState);
          }
        };

        const setupResultsBar = () => {
          const detail = elements.resultsBar;
          if (!detail) return;
          const media = window.matchMedia("(min-width: 900px)");
          const applyState = () => {
            detail.open = media.matches;
          };
          applyState();
          if (typeof media.addEventListener === "function") {
            media.addEventListener("change", applyState);
          } else if (typeof media.addListener === "function") {
            media.addListener(applyState);
          }
        };

        const init = () => {
          const stored = Storage.load();
          if (stored && stored.data) {
            State.set(stored.data);
          }
          syncInputsFromState();
          setupSections();
          setupResultsBar();
          renderResults();
          bindEvents();
        };

        return { init };
      })();

      window._paydayCalc = { State, Calculator };
      UI.init();
    </script>
  </body>
  </html>
